{% extends "base.html" %} {% block title %} Dashboard {% endblock %}
<!-- Element injected in the BODY element --> {% block body_class %} sidebar-mini {% endblock body_class %}
<!-- Specific Page CSS goes HERE  --> {% block stylesheets %}
<!-- Google Font: Source Sans Pro -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
<!-- Font Awesome -->
<link rel="stylesheet" href="/static/assets/plugins/fontawesome-free/css/all.min.css">
<!-- Ionicons -->
<link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
<!-- Tempusdominus Bootstrap 4 -->
<link rel="stylesheet" href="/static/assets/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
<!-- iCheck -->
<link rel="stylesheet" href="/static/assets/plugins/icheck-bootstrap/icheck-bootstrap.min.css">
<!-- JQVMap -->
<link rel="stylesheet" href="/static/assets/plugins/jqvmap/jqvmap.min.css">
<!-- Theme style -->
<link rel="stylesheet" href="/static/assets/css/adminlte.min.css">
<!-- overlayScrollbars -->
<link rel="stylesheet" href="/static/assets/plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
<!-- Daterange picker -->
<link rel="stylesheet" href="/static/assets/plugins/daterangepicker/daterangepicker.css">
<!-- summernote -->
<link rel="stylesheet" href="/static/assets/plugins/summernote/summernote-bs4.min.css">
<style>
  .alert-box {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 20px;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 10px;
    background-color: #f8f9fa;
  }
  .alert-item {
    padding: 8px;
    margin-bottom: 5px;
    border-radius: 3px;
  }
  .alert-danger {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
  }
  .alert-warning {
    background-color: #fff3cd;
    border-color: #ffeeba;
    color: #856404;
  }
  .danger-zone-info {
    margin-top: 10px;
    padding: 10px;
    background-color: #e9ecef;
    border-radius: 5px;
    font-size: 0.9em;
  }
  .settings-panel {
    margin-top: 15px;
    padding: 10px;
    background-color: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 5px;
  }
  .settings-row {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
  }
  .settings-row label {
    width: 150px;
    margin-bottom: 0;
  }
  .settings-row input {
    width: 100px;
    margin-right: 10px;
  }
  .settings-row .value-display {
    width: 40px;
    text-align: center;
    font-weight: bold;
  }
</style>
{% endblock stylesheets %} {% block content %} <div class="content-wrapper">
  <!-- Content Header (Page header) -->
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0 text-dark">YOLOv8 Dashboard</h1>
        </div>
        <!-- /.col -->
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item">
              <a href="index.html">Home</a>
            </li>
            <li class="breadcrumb-item active">View Detected Image</li>
          </ol>
        </div>
        <!-- /.col -->
      </div>
      <!-- /.row -->
    </div>
    <!-- /.container-fluid -->
  </div>
  <!-- /.content-header -->
  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      <!-- Small boxes (Stat box) -->
      <div class="row">
        <!-- ./col -->
      </div>
      <!-- /.row -->
      <!-- Main row -->
      <div class="row">
        <!-- Left col -->
        <section class="col-lg-6 connectedSortable">
          <!-- Custom tabs (Charts with tabs)-->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-chart-pie mr-1"></i> YOLOv8 Object Detection
              </h3>
            </div>
            <!-- /.card-header -->
            <div class="card-body">
              <div class="tab-content p-0">
                <!-- Morris chart - Sales -->
                <div class="chart tab-pane active" id="revenue-chart" style="position: relative; height: 700px;">
                  <!-- AI code-->
                  <form class="form-signin col-lg-3" method=post enctype=multipart/form-data name="form1">
                    <h3 class="h3 mb-3 font-weight-normal">Upload any image or video</h3>
                    <input type="file" name="file" class="form-control-file" id="inputfile">
                    <br />
                    <button class="btn btn-block btn-default btn-sm " type="submit">Upload</button>
                    <p class="mt-5 mb-3 text-muted">Built using Pytorch & Flask</p>
                  </form>
                  
                  <!-- 危险区域信息 -->
                  <div class="danger-zone-info">
                    <h5>Danger Zone Detection</h5>
                    <p>The system detects if objects enter the predefined danger zone and displays alerts below.</p>
                    <ul>
                      <li><strong style="color: green;">Green</strong>: Safe status</li>
                      <li><strong style="color: #FFFF00;">Yellow</strong>: Near danger zone</li>
                      <li><strong style="color: red;">Red</strong>: Staying in danger zone too long</li>
                    </ul>
                    <!-- 添加危险区域编辑按钮 -->
                    <div class="edit-controls">
                      <button id="edit-mode-btn" class="btn btn-warning">Edit Danger Zone</button>
                      <button id="save-zone-btn" class="btn btn-success" style="display:none;">Save Zone</button>
                      <button id="cancel-edit-btn" class="btn btn-danger" style="display:none;">Cancel</button>
                      <span id="edit-instructions" style="display:none; margin-left: 10px; color: #ff7700;">
                        <i class="fas fa-info-circle"></i> Click and drag points to adjust, right-click to delete, double-click to add new point
                      </span>
                    </div>
                    
                    <!-- 阈值设置面板 -->
                    <div class="settings-panel">
                      <h5>Detection Settings</h5>
                      <div class="settings-row">
                        <label for="safety-distance">Safety Distance (px):</label>
                        <input type="range" id="safety-distance" min="10" max="200" step="5" value="100">
                        <span id="safety-distance-value" class="value-display">100</span>
                      </div>
                      <div class="settings-row">
                        <label for="loitering-threshold">Alert Time Threshold (s):</label>
                        <input type="range" id="loitering-threshold" min="0.5" max="10" step="0.5" value="2">
                        <span id="loitering-threshold-value" class="value-display">2.0</span>
                      </div>
                      <button id="apply-settings-btn" class="btn btn-primary btn-sm">Apply Settings</button>
                    </div>
                  </div>
                  
                  <!-- 告警信息区域 -->
                  <div class="alert-box">
                    <h5>Alert Messages</h5>
                    <div id="alerts-container">
                      {% if alerts %}
                        {% for alert in alerts %}
                          <div class="alert-item alert-danger">{{ alert }}</div>
                        {% endfor %}
                      {% else %}
                        <p>No alerts at the moment</p>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->
        </section>
        <section class="col-lg-6 connectedSortable">
          <!-- Custom tabs (Charts with tabs)-->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-chart-pie mr-1"></i> Results
              </h3>
            </div>
            <!-- /.card-header -->
            <div class="card-body">
              <div class="tab-content p-0">
                  <div class="chart tab-pane active" id="result-container" style="position: relative; height: 700px;">
                      {% if media_type == 'image' %}
                          <img id="my-image" src="{{ url_for('display', filename=image_path, _external=True) }}" style="max-width: 100%; max-height: 100%; display: none;" />
                          <script>
                              document.getElementById("my-image").onload = function() {
                                  this.style.display = "block";
                              };
                          </script>
                      {% endif %}
          
                      <!-- {% if media_type == 'video' %}
                          <video id="my-video" controls style="max-width: 100%; max-height: 100%; display: none;">
                              <source src="{{ url_for('video_feed') }}" type="video/mp4">
                              Your browser does not support the video tag.
                          </video>
                          <script>
                            document.getElementById("my-video").style.display = "block";
                          </script>
                      {% endif %} -->
                      <img id="my-video-image" src="{{ url_for('video_feed') }}" style="max-width: 100%; max-height: 100%; display: none;" />
                      <script>
                        document.getElementById("my-video-image").onload = function() {
                          this.style.display = "block";
                        };
                      </script>   
                  </div>
              </div>
          </div>
          
          
            <!-- /.card-body -->
          </div>
          <!-- /.card -->
        </section>
        <!-- /.Left col -->
        <!-- right col (We are only adding the ID to make the widgets sortable)-->
        <!-- right col -->
      </div>
      <!-- /.row (main row) -->
    </div>
    <!-- /.container-fluid -->
  </section>
  <!-- /.content -->
</div> {% endblock content %}
<!-- Specific Page JS goes HERE  --> {% block javascripts %}
<!-- jQuery -->
<script src="/static/assets/plugins/jquery/jquery.min.js"></script>
<!-- jQuery UI 1.11.4 -->
<script src="/static/assets/plugins/jquery-ui/jquery-ui.min.js"></script>
<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
<script>
  $.widget.bridge('uibutton', $.ui.button)
</script>
<!-- Bootstrap 4 -->
<script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- ChartJS -->
<script src="/static/assets/plugins/chart.js/Chart.min.js"></script>
<!-- Sparkline -->
<script src="/static/assets/plugins/sparklines/sparkline.js"></script>
<!-- JQVMap -->
<script src="/static/assets/plugins/jqvmap/jquery.vmap.min.js"></script>
<script src="/static/assets/plugins/jqvmap/maps/jquery.vmap.usa.js"></script>
<!-- jQuery Knob Chart -->
<script src="/static/assets/plugins/jquery-knob/jquery.knob.min.js"></script>
<!-- daterangepicker -->
<script src="/static/assets/plugins/moment/moment.min.js"></script>
<script src="/static/assets/plugins/daterangepicker/daterangepicker.js"></script>
<!-- Tempusdominus Bootstrap 4 -->
<script src="/static/assets/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
<!-- Summernote -->
<script src="/static/assets/plugins/summernote/summernote-bs4.min.js"></script>
<!-- overlayScrollbars -->
<script src="/static/assets/plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
<!-- AdminLTE App -->
<script src="/static/assets/js/adminlte.js"></script>
<!-- AdminLTE dashboard demo (This is only for demo purposes) -->
<script src="/static/assets/js/pages/dashboard.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="/static/assets/js/demo.js"></script>

<!-- 实时更新告警信息的脚本 -->
<script>
  // 只在使用摄像头时定期更新告警信息
  if (document.getElementById("my-video-image").style.display !== "none") {
    // 每3秒更新一次告警信息
    setInterval(function() {
      fetch('/get_alerts')
        .then(response => response.json())
        .then(data => {
          const alertsContainer = document.getElementById('alerts-container');
          if (data.alerts && data.alerts.length > 0) {
            let alertsHtml = '';
            data.alerts.forEach(alert => {
              alertsHtml += `<div class="alert-item alert-danger">${alert}</div>`;
            });
            alertsContainer.innerHTML = alertsHtml;
          } else {
            alertsContainer.innerHTML = '<p>No alerts at the moment</p>';
          }
        })
        .catch(error => console.error('Error getting alerts:', error));
    }, 3000);
  }
  
  // 危险区域编辑模式控制
  document.addEventListener('DOMContentLoaded', function() {
    const editModeBtn = document.getElementById('edit-mode-btn');
    const saveZoneBtn = document.getElementById('save-zone-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const editInstructions = document.getElementById('edit-instructions');
    let originalZone = null;
    
    // 阈值设置控件
    const safetyDistanceSlider = document.getElementById('safety-distance');
    const safetyDistanceValue = document.getElementById('safety-distance-value');
    const loiteringThresholdSlider = document.getElementById('loitering-threshold');
    const loiteringThresholdValue = document.getElementById('loitering-threshold-value');
    const applySettingsBtn = document.getElementById('apply-settings-btn');
    
    // 获取当前配置
    function getConfig() {
      return fetch('/get_config')
        .then(response => response.json())
        .then(data => {
          // 更新滑块值
          safetyDistanceSlider.value = data.safety_distance;
          safetyDistanceValue.textContent = data.safety_distance;
          
          loiteringThresholdSlider.value = data.loitering_threshold;
          loiteringThresholdValue.textContent = data.loitering_threshold.toFixed(1);
          
          return data;
        });
    }
    
    // 初始化加载配置
    getConfig();
    
    // 更新滑块显示值
    safetyDistanceSlider.addEventListener('input', function() {
      safetyDistanceValue.textContent = this.value;
    });
    
    loiteringThresholdSlider.addEventListener('input', function() {
      loiteringThresholdValue.textContent = parseFloat(this.value).toFixed(1);
    });
    
    // 应用设置按钮
    applySettingsBtn.addEventListener('click', function() {
      const safetyDistance = parseInt(safetyDistanceSlider.value);
      const loiteringThreshold = parseFloat(loiteringThresholdSlider.value);
      
      fetch('/update_thresholds', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          safety_distance: safetyDistance,
          loitering_threshold: loiteringThreshold
        }),
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert('Settings updated successfully!');
        } else {
          alert('Warning: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error updating settings:', error);
        alert('Error updating settings. Please try again.');
      });
    });
    
    // 获取当前危险区域坐标
    function getDangerZone() {
      return fetch('/get_danger_zone')
        .then(response => response.json())
        .then(data => data.danger_zone);
    }
    
    // 保存危险区域坐标
    function saveDangerZone(zone) {
      return fetch('/update_danger_zone', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ danger_zone: zone }),
      })
      .then(response => response.json());
    }
    
    // 切换编辑模式
    function toggleEditMode(enabled) {
      return fetch('/toggle_edit_mode', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ edit_mode: enabled }),
      })
      .then(response => response.json());
    }
    
    // 进入编辑模式
    editModeBtn.addEventListener('click', function() {
      // 保存原始区域以便取消时恢复
      getDangerZone().then(zone => {
        originalZone = zone;
        toggleEditMode(true).then(() => {
          editModeBtn.style.display = 'none';
          saveZoneBtn.style.display = 'inline-block';
          cancelEditBtn.style.display = 'inline-block';
          editInstructions.style.display = 'inline-block';
        });
      });
    });
    
    // 保存编辑后的区域
    saveZoneBtn.addEventListener('click', function() {
      toggleEditMode(false).then(() => {
        getDangerZone().then(zone => {
          saveDangerZone(zone).then(() => {
            editModeBtn.style.display = 'inline-block';
            saveZoneBtn.style.display = 'none';
            cancelEditBtn.style.display = 'none';
            editInstructions.style.display = 'none';
            alert('Danger zone saved successfully!');
          });
        });
      });
    });
    
    // 取消编辑
    cancelEditBtn.addEventListener('click', function() {
      if (originalZone) {
        saveDangerZone(originalZone).then(() => {
          toggleEditMode(false).then(() => {
            editModeBtn.style.display = 'inline-block';
            saveZoneBtn.style.display = 'none';
            cancelEditBtn.style.display = 'none';
            editInstructions.style.display = 'none';
          });
        });
      }
    });
  });
</script>
{% endblock javascripts %}